server {
    listen          80;
    server_name     localhost;

    root /usr/share/nginx/html ;
    index index.html ;

    location / {
        try_files $uri /index.html;
    }

    location /generate_token {
        content_by_lua_block {
            local auth = require("auth")
            local role = "ADMIN"              
            ngx.say(auth.generate_token(role))
        }
    }

    location /userservice/info {
        proxy_pass   http://userservice:8000/ ;
    }

    location /userservice/cinema/health {
        proxy_pass   http://userservice:8000/userservice/cinema/health ;
    }

    location /cinemaservice/info/ {
        proxy_pass   http://cinemaservice:8001/ ;
    }
   
    location /users {
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'Authorization, DNT, X-CustomHeader, Keep-Alive, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type';
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain charset=UTF-8';
            add_header 'Content-Length' 0;
            return 204;
        }

        if ($request_method ~* "(GET|POST|PUT)") {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'Authorization, DNT, X-CustomHeader, Keep-Alive, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type';
        }

        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://userservice:8000/users ;
    }

    location /users/ {
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'Authorization, DNT, X-CustomHeader, Keep-Alive, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type';
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain charset=UTF-8';
            add_header 'Content-Length' 0;
            return 204;
        }

        if ($request_method = 'GET') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'Authorization, DNT, X-CustomHeader, Keep-Alive, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type';
        }

        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass http://userservice:8000/users/ ;
    }

    location /users/existed/ {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass http://userservice:8000/users/existed/ ;
    }
        
    location /login {
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain charset=UTF-8';
            add_header 'Content-Length' 0;
            return 204;
        }
        if ($request_method = 'POST') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
        }
        proxy_pass   http://userservice:8000/login ;
    }

    location /register {
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain charset=UTF-8';
            add_header 'Content-Length' 0;
            return 204;
        }
        if ($request_method = 'POST') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
        }
        proxy_pass   http://userservice:8000/users ;
    }


    location /refresh {
        proxy_pass   http://userservice:8000/refresh ;
    }
    
    location /cinema/auditoriums {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/cinema/auditoriums ;
    }

    location /cinema/auditoriums/ {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/cinema/auditorium/ ;
    }

    location /cinema/seats {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/cinema/seats ;
    }

    location /cinema/seats/available {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/cinema/seats/available ;
    }

    location /cinema/seats/reservations/ {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/cinema/seats/reservations/ ;
    }

    location /cinema/movies {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/cinema/movies ;
    }

    location /cinema/movies/ {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/cinema/movies/ ;
    }

    location /cinema/movie-schedules {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/cinema/movie-schedules ;
    }

    location /cinema/movie-schedules/ {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/cinema/movie-schedules/ ;
    }

    location /booking/ {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://bookingservice:8002/booking/ ;
    }

    location /bookings {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://bookingservice:8002/bookings ;
    }

    error_page 404 /index.html ;
}
