server {
    listen          80;
    server_name     localhost;

    root /usr/share/nginx/html ;
    index index.html ;

    location / {
        try_files $uri /index.html;
    }

    location /generate_token {
        content_by_lua_block {
            local auth = require("auth")
            local role = "ADMIN"              
            ngx.say(auth.generate_token(role))
        }
    }

    location /userservice/info {
        proxy_pass   http://userservice:8000/ ;
    }

    location /userservice/cinema/health {
        proxy_pass   http://userservice:8000/userservice/cinema/health ;
    }

    location /cinemaservice/info {
        proxy_pass   http://cinemaservice:8001/ ;
    }
   
    location /users {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://userservice:8000/users ;
    }

    location /users/ {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass http://userservice:8000/users/ ;
    }

    location /users/existed/ {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass http://userservice:8000/users/existed/ ;
    }
        
    location /login {
        proxy_pass   http://userservice:8000/login ;
    }

    location /refresh {
        proxy_pass   http://userservice:8000/refresh ;
    }
    
    location /cinema/auditoriums {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/cinema/auditoriums ;
    }

    location /cinema/auditoriums/ {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/cinema/auditorium/ ;
    }

    location /cinema/seats {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/cinema/seats ;
    }

    location /cinema/seats/available {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/cinema/seats/available ;
    }

    location /cinema/seats/reservations/ {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/cinema/seats/reservations/ ;
    }

    location /cinema/movies {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/cinema/movies ;
    }

    location /cinema/movies/ {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/cinema/movies/ ;
    }

    location /cinema/movie-schedules {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/cinema/movie-schedules ;
    }

    location /cinema/schedules {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/cinema/schedules ;
    }

    location /booking/ {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://bookingservice:8002/booking/ ;
    }

    location /bookings {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://bookingservice:8002/bookings ;
    }

    error_page 404 /index.html ;
}
