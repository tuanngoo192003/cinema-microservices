server {
    listen          80;
    server_name     localhost;

    root /usr/share/nginx/html ;
    index index.html ;

    location / {
        try_files $uri /index.html;
    }

    location /generate_token {
        content_by_lua_block {
            local auth = require("auth")
            local role = "ADMIN"              
            ngx.say(auth.generate_token(role))
        }
    }

    location /userservice/info {
        proxy_pass   http://userservice:8000/ ;
    }

    location /userservice/cinema/health {
        proxy_pass   http://userservice:8000/userservice/cinema/health ;
    }

    location /cinemaservice/info {
        proxy_pass   http://cinemaservice:8001/ ;
    }
   
    location /user {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://userservice:8000/user ;
    }

    location /user/ {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass http://userservice:8000/user/ ;
    }

    location /user/existed/ {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass http://userservice:8000/user/existed/ ;
    }
        
    location /login {
        proxy_pass   http://userservice:8000/login ;
    }

    location /refresh {
        proxy_pass   http://userservice:8000/refresh ;
    }

    location /users {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://userservice:8000/users ;
    }

    location /cinema/auditorium {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/auditorium ;
    }

    location /cinema/auditoriums {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/auditoriums ;
    }


    location /cinema/auditorium/ {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/auditorium/ ;
    }

    location /cinema/seats {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/seats ;
    }

    location /cinema/seat/check/ {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/seat/check/ ;
    }

    location /cinema/seat/reserve/ {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/seat/reserve/ ;
    }

    location /cinema/movies {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/movies ;
    }

    location /cinema/movie {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/movie ;
    }

    location /cinema/movie/ {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/movie/ ;
    }

    location /cinema/movie-schedule {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/movie-schedule ;
    }

    location /cinema/schedules {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://cinemaservice:8001/schedules ;
    }

    location /booking/ {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://bookingservice:8002/booking/ ;
    }

    location /booking {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://bookingservice:8002/booking ;
    }


    location /bookings {
        access_by_lua_block {
            require("auth").check_jwt_role()
        }
        proxy_pass   http://bookingservice:8002/bookings ;
    }

    error_page 404 /index.html ;
}
